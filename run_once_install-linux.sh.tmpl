#!/bin/sh
set -e

if [ "{{ .chezmoi.os }}" != "linux" ]; then
  exit 0
fi

if ! command -v apt-get >/dev/null 2>&1; then
  echo "apt-get is required but not installed." >&2
  exit 1
fi

sudo apt-get update

for pkg in zoxide ripgrep micro fzf tldr bat btop lazygit; do
  if ! apt-cache show "$pkg" >/dev/null 2>&1; then
    echo "$pkg package not found via apt-get." >&2
    exit 1
  fi
done

sudo apt-get install -y zoxide ripgrep micro fzf tldr bat btop lazygit

if ! command -v starship >/dev/null 2>&1; then
  if ! command -v curl >/dev/null 2>&1; then
    sudo apt-get install -y curl
  fi
  curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

if ! command -v eza >/dev/null 2>&1; then
  if ! command -v gpg >/dev/null 2>&1; then
    sudo apt-get install -y gpg
  fi
  if ! command -v wget >/dev/null 2>&1; then
    sudo apt-get install -y wget
  fi
  sudo mkdir -p /etc/apt/keyrings
  wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
  echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list >/dev/null
  sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
  sudo apt-get update
  sudo apt-get install -y eza
fi

if [ -d "$HOME/.antidote/.git" ]; then
  git -C "$HOME/.antidote" pull --ff-only
elif [ ! -d "$HOME/.antidote" ]; then
  git clone https://github.com/mattmc3/antidote.git "$HOME/.antidote"
fi
